<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Deutschlandticket</title>
    <style>
        html {
            box-sizing: border-box;
            -webkit-text-size-adjust: 100%;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #164094;
            display: flex;
            overflow-y: auto;
            justify-content: center;
            align-items: stretch;
            min-height: 100dvh;
        }
        .main-container {
            width: 100%;
            max-width: 480px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            min-height: 0;
            padding-bottom: 10px;
        }
        .ticket-container {
            background: #fff;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            min-height: 0;
            margin-bottom: 10px;
        }
        .ticket-header {
            background: linear-gradient(112.91deg, #ffffff82 3.51%, #fff0 111.71%), #164094;
            color: #fff;
            text-align: center;
            padding: 1.5rem;
            font-weight: bold;
            font-size: 1.5rem;
        }
        .ticket-logos {
            display: flex;
            justify-content: center;
            align-items: center;
            padding-top: 1rem;
            margin-bottom: 0.75rem;
        }
        .ticket-logos img {
            height: 1.5rem;
            width: auto;
        }
        .ticket-qr {
            display: flex;
            justify-content: center;
            padding: 24px;
            box-sizing: border-box;
        }
        .ticket-qr img {
            width: 100%;
            max-width: 398px;
            height: auto;
            aspect-ratio: 1/1;
        }
        .ticket-slider {
            position: relative;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin: 1.25rem auto;
            width: 90%;
            max-width: 350px;
            overflow: hidden;
        }
        .slider-thumb {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 12px;
            background-color: #2196f3;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        .ticket-number {
            text-align: center;
            font-size: 1.25rem;
            line-height: 1.75rem;
            padding: 0.625rem 0;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            margin: 1rem;
        }
        .main-info {
            background-color: #f9fafb;
            border-top: 1px solid #ddd;
            flex: 1;
        }
        .ticket-details, .ticket-details2 {
            font-size: 0.875rem;
        }
        .ticket-details div, .ticket-details2 div {
            padding: 0.5rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: rgb(102, 112, 133);
            font-weight: 400;
        }
        .label svg {
            width: 25px;
            height: 16px;
            flex-shrink: 0;
            fill: #667085;
        }
        .info {
            color: rgb(16, 24, 40);
            font-weight: 600;
        }
        .border-bottom {
            margin: 1.5rem 0;
            border-bottom: 1px solid #ddd;
        }
        .border-bottom_double {
            margin: 0;
            border-bottom: 1px solid #ddd;
        }
        .small-text {
            margin-top: 1.5rem;
            font-size: 0.75rem;
            color: #667085;
            padding: 0 1.5rem 1.5rem;
            text-align: left;
        }
        @media (max-width: 600px) {
            body {
                display: block;
                min-height: 100dvh;
                overflow-y: auto;
                margin: 0;
            }
            .main-container {
                padding: 17px 16px;
                height: auto;
                min-height: 0;
            }
            .ticket-container {
                height: auto;
                min-height: auto;
            }
            .ticket-header {
                font-size: 1.25rem;
                font-weight: 600;
                line-height: 1.75rem;
                padding: 24px;
                border: 1px solid #ffffff9c;
                box-sizing: border-box;
                border-top-left-radius: 1rem;
                border-top-right-radius: 1rem;
            }
            .ticket-logos {
                padding-top: 24px;
            }
            .ticket-logos img {
                height: 24px;
                width: 37px;
            }
            .ticket-slider {
                width: 85%;
                max-width: 300px;
            }

            .ticket-qr img {
                width: 100%;
                max-width: 343px;
                height: auto;
                aspect-ratio: 1/1;
            }
            .ticket-number {
                font-size: 1.25rem;
                line-height: 1.75rem;
                padding: 16px;
                border: 1px solid #ddd;
                border-radius: 0.5rem;
                margin: 0 24px 24px;
            }
            .ticket-details, .ticket-details2 {
                font-size: 0.75rem;
            }
            .ticket-details div, .ticket-details2 div {
                padding: 0.5rem 1rem;
            }
            .small-text {
                font-size: 0.7rem;
                padding: 24px;
                border-top: 1px solid #ddd;
            }
        }
        @media (max-width: 421px) {
            .ticket-logos {
                padding-top: 24px;
            }
            .ticket-logos img {
                height: 24px;
                width: 37px;
            }
            .ticket-qr img {
                width: 100%;
                max-width: 343px;
                height: auto;
                aspect-ratio: 1/1;
            }
            .ticket-number {
                font-family:Arial, sans-serif;
                font-size:20px;
                line-height:28px;
            }
            .small-text { font-size: 12px; padding: 24px;margin: 0;border-top: 1px solid #ddd; font-family:Arial, sans-serif;line-height: 18px;}
            .border-bottom { margin: 1rem 0; }
            .ticket-details div,
            .ticket-details2 div {
                flex-direction: column;      /* колоночная структура */
                align-items: flex-start;     /* прижимаем к левому краю */
                gap: 0.25rem;
                padding: 0 24px 12px 24px;/* отступ между label и info */
            }

            .ticket-details div:first-child,
            .ticket-details2 div:first-child{
                padding-top: 24px;
            }
            .ticket-details div:last-child,
            .ticket-details2 div:last-child{
                padding-bottom: 24px;
            }
            .border-bottom {
                margin: 0;
            }
            .label {
                font-family: Arial, sans-serif;
                font-size: 14px;
                line-height:20px;
            }
            .info {
                font-family: Arial, sans-serif;
                align-self: flex-start;
                margin-left: 34px;
                width: 100%;                 /* растягиваем на всю ширину */
                font-weight: 600;
                word-wrap: break-word;
                font-size: 14px;
                line-height:20px/* если текст длинный */
            }

        }
    </style>
</head>
<body>
<div class="main-container">
    <div class="ticket-container">
        <div class="ticket-header">Deutschlandticket</div>
        <div class="ticket-logos">
            <img src="https://ride-production-public-data.obs.eu-de.otc.t-systems.com/partner/Lzbyh1qZ0ZWCLkV5mudl_pader/Logo_E-Ticket.svg" alt="Logo">
        </div>
        <div class="ticket-qr">
            <img src="qr.png" alt="QR Code" id="qrImg">
        </div>
        <div class="ticket-number" id="ticketNumber"></div>
        <div class="ticket-slider" id="ticketSlider">
            <div class="slider-thumb" id="sliderThumb"></div>
        </div>
        <div class="main-info">
            <div class="ticket-details">
                <div>
                    <span class="label">
                        <svg viewBox="0 0 20 20"><path fill-rule="evenodd" clip-rule="evenodd" d="M10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18ZM11 6C11 5.44772 10.5523 5 10 5C9.44772 5 9 5.44772 9 6V10C9 10.2652 9.10536 10.5196 9.29289 10.7071L12.1213 13.5355C12.5118 13.9261 13.145 13.9261 13.5355 13.5355C13.9261 13.145 13.9261 12.5118 13.5355 12.1213L11 9.58579V6Z"/></svg>
                        Gültig von:
                    </span>
                    <span class="info" id="validFrom"></span>
                </div>
                <div>
                    <span class="label">
                        <svg></svg>
                        Gültig bis:
                    </span>
                    <span class="info" id="validUntil"></span>
                </div>
                <div>
                    <span class="label">
                        <svg></svg>
                        Ausgestellt:
                    </span>
                    <span class="info" id="issuedAt"></span>
                </div>
                <div>
                    <span class="label">
                        <svg></svg>
                        Geltungsbereich:
                    </span>
                    <span class="info" id="region"></span>
                </div>
                <div>
                    <span class="label">
                        <svg></svg>
                        Klasse:
                    </span>
                    <span class="info" id="class">2. Klasse</span>
                </div>
                <div>
                    <span class="label">
                        <svg width="100%" height="100%" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" fit="" preserveAspectRatio="xMidYMid meet" focusable="false">
                            <path d="M14 5.5C14 7.36384 12.7252 8.92994 11 9.37398V13C11 13.5523 10.5523 14 10 14C9.44771 14 9 13.5523 9 13V9.37398C7.27477 8.92994 6 7.36384 6 5.5C6 3.29086 7.79086 1.5 10 1.5C12.2091 1.5 14 3.29086 14 5.5Z"></path>
                            <path d="M1.5 14.5C1.5 12.7003 4.02566 11.1782 7.5 10.6758V13C7.5 14.3807 8.61929 15.5 10 15.5C11.3807 15.5 12.5 14.3807 12.5 13V10.6758C15.9743 11.1782 18.5 12.7003 18.5 14.5C18.5 16.7091 14.6944 18.5 10 18.5C5.30558 18.5 1.5 16.7091 1.5 14.5Z"></path>
                        </svg>
                        Preisstufe:
                    </span>
                    <span class="info" id="priceLevel"></span>
                </div>
            </div>
            <div class="border-bottom"></div>
            <div class="ticket-details2">
                <div>
                    <span class="label">
                        <svg viewBox="0 0 14 16"><path d="M7 7C8.933 7 10.5 5.433 10.5 3.5C10.5 1.567 8.933 0 7 0C5.067 0 3.5 1.567 3.5 3.5C3.5 5.433 5.067 7 7 7z"/><path d="M5.15 8.62627C4.25072 8.26964 3.20665 8.03441 2.42 8.5975C0.933754 9.66135 0 11.2012 0 13.3333C0 14.8061 1.19724 16 2.67 16H11.34C12.8128 16 14 14.8061 14 13.3333C14 11.2012 13.0662 9.66134 11.58 8.59749C10.7934 8.03441 9.75928 8.26964 8.86 8.62627C8.25186 8.86744 7.6951 9 7.0011 9C6.3071 9 5.75814 8.86744 5.15 8.62627Z"/></svg>
                        Ticketinhaber*in:
                    </span>
                    <span class="info" id="fullname"></span>
                </div>
                <div>
                    <span class="label">
                        <svg viewBox="0 0 16 17"><path fill-rule="evenodd" clip-rule="evenodd" d="M3 1C3 0.447715 3.44772 0 4 0C4.55228 0 5 0.447715 5 1H11C11 0.447715 11.4477 0 12 0C12.5523 0 13 0.447715 13 1C14.6569 1 16 2.34315 16 4V14C16 15.6569 14.6569 17 13 17H3C1.34315 17 0 15.6569 0 14V4C0 2.34315 1.34315 1 3 1ZM3 3C2.44772 3 2 3.44772 2 4V6H14V4C14 3.44772 13.5523 3 13 3H3ZM9.00002 9C9.00002 8.7234 8.84778 8.46926 8.60391 8.33875C8.36004 8.20823 8.06414 8.22254 7.83399 8.37596L6.33399 9.37596C5.98935 9.60573 5.89622 10.0714 6.12598 10.416C6.35575 10.7607 6.8214 10.8538 7.16604 10.624L7.50002 10.4014V14C7.50002 14.4142 7.8358 14.75 8.25002 14.75C8.66423 14.75 9.00002 14.4142 9.00002 14V9Z"/></svg>
                        Geburtsdatum:
                    </span>
                    <span class="info" id="birthdate"></span>
                </div>
            </div>
            <div class="small-text">
                Deutschlandweit gültig in allen Nahverkehrsmitteln <br>(ÖPNV/SPNV) 2. Klasse
            </div>
        </div>
    </div>
</div>
<script>

    (async function(){
        const params = new URLSearchParams(window.location.search);
        const key = params.get('key');
        if (!key) {
            alert('Ключ билета не найден');
            return;
        }

        function formatDateTime(iso) {
            if (!iso) return '';
            const d = new Date(iso);
            const pad = n => String(n).padStart(2, '0');
            return `${pad(d.getDate())}.${pad(d.getMonth() + 1)}.${d.getFullYear()} - ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }

        function formatIssued(iso) {
            if (!iso) return '';
            const d = new Date(iso);
            if (isNaN(d)) return ''; // <-- защита от Invalid Date
            const pad = n => String(n).padStart(2, '0');
            return `${pad(d.getDate())}.${pad(d.getMonth() + 1)}.${d.getFullYear()}, ${pad(d.getHours())}:${pad(d.getMinutes())} Uhr`;}

        try {
            const res = await fetch('/api/tickets');
            if (!res.ok) throw new Error('Не удалось получить билеты с сервера');
            const tickets = await res.json();
            const ticket = tickets.find(t => t.key === key);
            if (!ticket) {
                alert('Билет с таким ключом не найден');
                return;
            }

            const setText = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value || '';
            };
            const setSrc = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.src = value || '';
            };

            setText('ticketNumber', ticket.ticketNumber);
            setSrc('qrImg', ticket.qrcode || 'qr.png');
            setText('validFrom', ticket.validFromISO ? formatDateTime(ticket.validFromISO) : '');
            setText('validUntil', ticket.validUntilISO ? formatDateTime(ticket.validUntilISO) : '');
            setText('issuedAt', ticket.issuedAtISO ? formatIssued(ticket.issuedAtISO) : '');
            if(ticket.region) {
                setText('region', ticket.region.charAt(0).toUpperCase() + ticket.region.slice(1));
            } else {
                setText('region', 'Deutschlandweit');
            }
            setText('class', '2. Klasse'); // Фиксированное значение, т.к. не передается в API
            setText('priceLevel', ticket.priceLevel || 'deutschlandweit');
            setText('fullname', ticket.fullname);
            setText('birthdate', ticket.birthdate);
        } catch (err) {
            console.error(err);
            alert(err.message);
        }

        // Анимация бегунка
        const thumb = document.getElementById('sliderThumb');
        const slider = thumb.parentElement;
        let pos = 0, direction = 1, speed = 2;
        function animate() {
            const maxPos = slider.clientWidth - thumb.clientWidth;
            pos += speed * direction;
            if (pos <= 0) { pos = 0; direction = 1; }
            if (pos >= maxPos) { pos = maxPos; direction = -1; }
            thumb.style.left = pos + 'px';
            requestAnimationFrame(animate);
        }
        animate();
    })();
</script>
</body>
</html>