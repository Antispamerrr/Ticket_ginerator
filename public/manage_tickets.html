<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–∞–º–∏</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f2f5; }
        h1 { text-align: center; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background: #007bff; color: #fff; }
        tr:hover { background: #f1f5f9; }
        button { padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; background: #28a745; color: #fff; }
        button:hover { background: #218838; }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            width: 420px;
        }
        .modal-content h2 { margin-top: 0; }
        .modal-content label { display: block; margin: 8px 0; }
        .modal-content input { width: 100%; padding: 6px; margin-top: 4px; }
        .modal-content img { display: block; margin: 10px auto; max-width: 200px; }
        .modal-content .actions { margin-top: 10px; text-align: right; }
        .modal-content .actions button { margin-left: 10px; }
    </style>
</head>
<body>

<h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–∞–º–∏</h1>
<table id="ticketsTable">
    <thead>
    <tr>
        <th>‚Ññ</th>
        <th>–ò–º—è</th>
        <th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th>
        <th>–ù–∞—á–∞–ª–æ –¥–µ–π—Å—Ç–≤–∏—è</th>
        <th>–û–∫–æ–Ω—á–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</th>
        <th>–í—ã–¥–∞–Ω</th>
        <th>–ú–µ—Å—Ç–æ –¥–µ–π—Å—Ç–≤–∏—è</th>
        <th>–ö–ª–∞—Å—Å</th>
        <th>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</th>
        <th>–°—Å—ã–ª–∫–∞</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div class="modal" id="editModal">
    <div class="modal-content">
        <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∏–ª–µ—Ç–∞</h2>
        <form id="editForm">
            <input type="hidden" name="key">
            <label>–ò–º—è: <input type="text" name="fullname" required></label>
            <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: <input type="date" name="birthdate" required></label>
            <label>–ù–∞—á–∞–ª–æ –¥–µ–π—Å—Ç–≤–∏—è: <input type="datetime-local" name="validFromISO" required></label>
            <label>–û–∫–æ–Ω—á–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è: <input type="datetime-local" name="validUntilISO" required></label>
            <label>–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏ (Ausgestellt): <input type="datetime-local" name="issuedAtISO" required></label>
            <label>–ú–µ—Å—Ç–æ: <input type="text" name="region" required></label>
            <label>–ö–ª–∞—Å—Å: <input type="text" name="class" required></label>
            <label>Preisstufe: <input type="text" name="priceLevel" required></label>
            <label>–ù–æ–º–µ—Ä –±–∏–ª–µ—Ç–∞: <input type="text" name="ticketNumber" required></label>
            <label>QR-–∫–æ–¥ (–Ω–æ–≤—ã–π, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å):
                <input type="file" id="qrfile" accept="image/*">
            </label>
            <img id="qrPreview" alt="QR Code">
            <div class="actions">
                <button type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<script>
    let ticketsList = [];
    let currentTicket = null;

    async function fetchTickets() {
        const res = await fetch('/api/tickets');
        ticketsList = await res.json();
        renderTable(ticketsList);
    }

    function renderTable(tickets) {
        const tableBody = document.querySelector('#ticketsTable tbody');
        tableBody.innerHTML = '';
        tickets.forEach(ticket => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
      <td>${ticket.ticketNumber}</td>
      <td>${ticket.fullname}</td>
      <td>${ticket.birthdate}</td>
      <td>${ticket.validFrom}</td>
      <td>${ticket.validUntil}</td>
      <td>${ticket.issuedAt}</td>
      <td>${ticket.region}</td>
      <td>${ticket.class}</td>
<td>${ticket.priceLevel}</td>
      <td><button data-key="${ticket.key}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button></td>
      <td><a href="ticket.html?key=${ticket.key}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å</a></td>
    `;
            tableBody.appendChild(tr);
        });

        document.querySelectorAll('button[data-key]').forEach(btn => {
            btn.addEventListener('click', () => openEditModal(btn.dataset.key));
        });
    }

    function openEditModal(key) {
        currentTicket = ticketsList.find(t => t.key === key);
        if (!currentTicket) return;

        editForm.key.value = currentTicket.key;
        editForm.fullname.value = currentTicket.fullname;
        editForm.birthdate.value = currentTicket.birthdate;
        editForm.validFromISO.value = currentTicket.validFromISO || '';
        editForm.validUntilISO.value = currentTicket.validUntilISO || '';
        editForm.issuedAtISO.value = currentTicket.issuedAtISO || '';
        editForm.region.value = currentTicket.region || '';
        editForm.priceLevel.value = currentTicket.priceLevel || '';
        editForm.class.value = currentTicket.class || '';
        editForm.ticketNumber.value = currentTicket.ticketNumber;
        qrPreview.src = currentTicket.qrcode || '';

        editModal.style.display = 'flex';
    }

    editForm.addEventListener('submit', async e => {
        e.preventDefault();
        if (!currentTicket) return;

        const formData = new FormData(editForm);
        let updatedTicket = Object.fromEntries(formData.entries());

// üìå –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É issuedAt
        if (updatedTicket.issuedAtISO) {
            const d = new Date(updatedTicket.issuedAtISO);
            const pad = n => n.toString().padStart(2, '0');
            updatedTicket.issuedAt =
                `${pad(d.getDate())}.${pad(d.getMonth() + 1)}.${d.getFullYear()}, ` +
                `${pad(d.getHours())}:${pad(d.getMinutes())} Uhr`;
        }

        const fileInput = document.getElementById('qrfile');
        if (fileInput.files.length > 0) {
            const reader = new FileReader();
            reader.onload = async ev => {
                updatedTicket.qrcode = ev.target.result;
                await saveTicket(updatedTicket);
            };
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            updatedTicket.qrcode = currentTicket.qrcode || '';
            await saveTicket(updatedTicket);
        }
    });

    async function saveTicket(ticketData) {
        try {
            const res = await fetch(`/api/tickets/${ticketData.key}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(ticketData)
            });
            if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –±–∏–ª–µ—Ç–∞');
            closeModal();
            fetchTickets();
        } catch (err) {
            alert(err.message);
            console.error(err);
        }
    }

    fetchTickets();
    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
    }
</script>


</body>
</html>
