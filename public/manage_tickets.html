<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Управление билетами</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f2f5; }
        h1 { text-align: center; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background: #007bff; color: #fff; }
        tr:hover { background: #f1f5f9; }
        button { padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; background: #28a745; color: #fff; }
        button:hover { background: #218838; }

        /* Модальное окно */
        .modal {
            display: none;
            position: fixed;
            top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            width: 420px;
        }
        .modal-content h2 { margin-top: 0; }
        .modal-content label { display: block; margin: 8px 0; }
        .modal-content input { width: 100%; padding: 6px; margin-top: 4px; }
        .modal-content img { display: block; margin: 10px auto; max-width: 200px; }
        .modal-content .actions { margin-top: 10px; text-align: right; }
        .modal-content .actions button { margin-left: 10px; }
    </style>
</head>
<body>

<h1>Управление билетами</h1>
<table id="ticketsTable">
    <thead>
    <tr>
        <th>№</th>
        <th>Имя</th>
        <th>Дата рождения</th>
        <th>Начало действия</th>
        <th>Окончание действия</th>
        <th>Выдан</th>
        <th>Редактировать</th>
        <th>Ссылка</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Модальное окно редактирования -->
<div class="modal" id="editModal">
    <div class="modal-content">
        <h2>Редактирование билета</h2>
        <form id="editForm">
            <input type="hidden" name="key">
            <label>Имя: <input type="text" name="fullname" required></label>
            <label>Дата рождения: <input type="text" name="birthdate" placeholder="DD.MM.YYYY" required></label>
            <label>Начало действия (только месяц менять): <input type="month" name="validFromISO" required></label>
            <label>Окончание действия (только месяц менять): <input type="month" name="validUntilISO" required></label>
            <label>Дата выдачи (Ausgestellt): <input type="text" name="issuedAtISO" placeholder="DD.MM.YYYY, HH:MM Uhr" required></label>
            <label>Номер билета: <input type="text" name="ticketNumber" readonly></label>
            <label>QR-код (новый, если нужно заменить):
                <input type="file" id="qrfile" accept="image/*">
            </label>
            <img id="qrPreview" alt="QR Code">
            <div class="actions">
                <button type="button" onclick="closeModal()">Отмена</button>
                <button type="submit">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<script>
    let ticketsList = [];
    let currentTicket = null;

    // Форматирование для таблицы
    const formatDisplay = iso => {
        if (!iso) return '';
        const d = new Date(iso);
        const pad = n => String(n).padStart(2,'0');
        return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}, ${pad(d.getHours())}:${pad(d.getMinutes())} Uhr`;
    };

    // Сохраняем день, часы, минуты при изменении месяца
    function preserveTime(oldISO, newMonthISO) {
        if (!oldISO) return newMonthISO + "-01T00:00"; // fallback
        const oldDate = new Date(oldISO);
        const [year, month] = newMonthISO.split('-');
        return new Date(
            Number(year),
            Number(month)-1,
            oldDate.getDate(),
            oldDate.getHours(),
            oldDate.getMinutes()
        ).toISOString();
    }

    async function fetchTickets() {
        const res = await fetch('/api/tickets');
        ticketsList = await res.json();
        renderTable(ticketsList);
    }

    function renderTable(tickets) {
        const tableBody = document.querySelector('#ticketsTable tbody');
        tableBody.innerHTML = '';
        tickets.forEach(ticket => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td>${ticket.ticketNumber}</td>
            <td>${ticket.fullname}</td>
            <td>${ticket.birthdate}</td>
            <td>${ticket.validFromISO ? formatDisplay(ticket.validFromISO) : ''}</td>
            <td>${ticket.validUntilISO ? formatDisplay(ticket.validUntilISO) : ''}</td>
            <td>${ticket.issuedAtISO || ticket.issuedAt}</td>
            <td><button data-key="${ticket.key}">Редактировать</button></td>
            <td><a href="ticket.html?key=${ticket.key}" target="_blank">Открыть</a></td>
        `;
            tableBody.appendChild(tr);
        });

        document.querySelectorAll('button[data-key]').forEach(btn => {
            btn.addEventListener('click', () => openEditModal(btn.dataset.key));
        });
    }

    function openEditModal(key) {
        currentTicket = ticketsList.find(t => t.key === key);
        if (!currentTicket) return;

        editForm.key.value = currentTicket.key;
        editForm.fullname.value = currentTicket.fullname;
        editForm.birthdate.value = currentTicket.birthdate;
        editForm.validFromISO.value = currentTicket.validFromISO ? currentTicket.validFromISO.slice(0,7) : '';
        editForm.validUntilISO.value = currentTicket.validUntilISO ? currentTicket.validUntilISO.slice(0,7) : '';
        editForm.issuedAtISO.value = currentTicket.issuedAtISO || currentTicket.issuedAt || '';
        editForm.ticketNumber.value = currentTicket.ticketNumber;
        qrPreview.src = currentTicket.qrcode || '';

        editModal.style.display = 'flex';
    }

    editForm.addEventListener('submit', async e => {
        e.preventDefault();
        if (!currentTicket) return;

        const formData = new FormData(editForm);
        let updatedTicket = Object.fromEntries(formData.entries());

        // Обработка дат validFrom и validUntil — сохраняем день и время
        updatedTicket.validFromISO = preserveTime(currentTicket.validFromISO, updatedTicket.validFromISO);
        updatedTicket.validUntilISO = preserveTime(currentTicket.validUntilISO, updatedTicket.validUntilISO);

        // Обработка даты выдачи
        updatedTicket.issuedAt = updatedTicket.issuedAtISO;
        updatedTicket.ticketNumber = currentTicket.ticketNumber;
        // Обработка QR-кода
        const fileInput = document.getElementById('qrfile');
        if (fileInput.files.length > 0) {
            const reader = new FileReader();
            reader.onload = async ev => {
                updatedTicket.qrcode = ev.target.result;
                await saveTicket(updatedTicket);
            };
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            updatedTicket.qrcode = currentTicket.qrcode || '';
            await saveTicket(updatedTicket);
        }
    });

    async function saveTicket(ticketData) {
        try {
            const res = await fetch(`/api/tickets/${ticketData.key}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(ticketData)
            });
            if (!res.ok) throw new Error('Ошибка при обновлении билета');
            closeModal();
            fetchTickets();
        } catch (err) {
            alert(err.message);
            console.error(err);
        }
    }

    fetchTickets();

    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
    }
</script>

</body>
</html>
