<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Управление билетами</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f2f5; }
        h1 { text-align: center; margin-bottom: 10px; }
        #search { width: 100%; max-width: 400px; margin: 10px auto 20px; display:block; padding: 8px; border-radius: 5px; border:1px solid #ccc; }
        table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background: #007bff; color: #fff; }
        tr:hover { background: #f1f5f9; }
        button { padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; background: #28a745; color: #fff; }
        button:hover { background: #218838; }
        a { color:#007bff; text-decoration:none; }
        a:hover { text-decoration:underline; }
        .modal { display: none; position: fixed; top: 0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background:#fff; padding:20px; border-radius:10px; max-width:500px; width:100%; position:relative; }
        label { display:block; margin:10px 0 5px; }
        input { width:100%; padding:6px; border-radius:5px; border:1px solid #ccc; }
        .modal button { margin-top:10px; background:#007bff; }
        .modal button:hover { background:#0056b3; }
        .close { position:absolute; top:10px; right:15px; font-size:18px; cursor:pointer; color:#333; }
    </style>
</head>
<body>

<h1>Управление билетами</h1>
<input type="text" id="search" placeholder="Поиск по имени или номеру билета">

<table id="ticketsTable">
    <thead>
    <tr>
        <th>№</th>
        <th>Имя</th>
        <th>Дата рождения</th>
        <th>Отправление</th>
        <th>Прибытие</th>
        <th>Место</th>
        <th>Класс</th>
        <th>Редактировать</th>
        <th>Ссылка</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="modal" id="editModal">
    <div class="modal-content">
        <span class="close" id="closeModal">&times;</span>
        <h2>Редактировать билет</h2>
        <form id="editForm">
            <label>Имя и фамилия:<input type="text" name="fullname"></label>
            <label>Дата рождения:<input type="date" name="birthdate"></label>
            <label>Время отправления:<input type="text" name="departure" placeholder="ГГГГ-ММ-ДД - ЧЧ:ММ"></label>
            <label>Время прибытия:<input type="text" name="arrival" placeholder="ГГГГ-ММ-ДД - ЧЧ:ММ"></label>
            <label>Место:<input type="text" name="place"></label>
            <label>Класс вагона:<input type="text" name="class"></label>
            <label>Номер билета:<input type="text" name="ticketNumber"></label>
            <label>QR-код (файл изображения):<input type="file" name="qrcodeFile" accept="image/*"></label>
            <button type="submit">Сохранить изменения</button>
        </form>
    </div>
</div>

<script>
    const tableBody = document.querySelector('#ticketsTable tbody');
    const modal = document.getElementById('editModal');
    const closeModal = document.getElementById('closeModal');
    const editForm = document.getElementById('editForm');
    let tickets = [];
    let currentKey = null;

    // Получаем билеты с сервера
    function fetchTickets(){
        fetch('/api/tickets')
            .then(res=>res.json())
            .then(data=>{
                tickets = data;
                renderTable(filteredTickets());
            });
    }

    // Отображение таблицы
    function renderTable(filteredTickets = tickets){
        tableBody.innerHTML = '';
        filteredTickets.forEach((ticket, index)=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
      <td>${ticket.ticketNumber || index+1}</td>
      <td>${ticket.fullname}</td>
      <td>${ticket.birthdate}</td>
      <td>${ticket.departure}</td>
      <td>${ticket.arrival}</td>
      <td>${ticket.place}</td>
      <td>${ticket.class}</td>
      <td><button data-key="${ticket.key}">Редактировать</button></td>
      <td><a href="ticket.html?key=${ticket.key}" target="_blank">Открыть</a></td>
    `;
            tableBody.appendChild(tr);
        });
    }

    // Модальное окно редактирования
    tableBody.addEventListener('click', e=>{
        if(e.target.tagName==='BUTTON'){
            const key = e.target.dataset.key;
            currentKey = key;
            const ticket = tickets.find(t=>t.key===key);
            for(const name in ticket){
                if(editForm[name]) editForm[name].value = ticket[name];
            }
            modal.style.display = 'flex';
        }
    });

    closeModal.onclick = () => modal.style.display = 'none';
    window.onclick = e => { if(e.target===modal) modal.style.display = 'none'; }

    // Сохранение изменений
    editForm.addEventListener('submit', e=>{
        e.preventDefault();
        const updated = {};
        for(const elem of editForm.elements){
            if(elem.name && elem.name!=='qrcodeFile') updated[elem.name] = elem.value;
        }

        const fileInput = editForm.qrcodeFile;
        if(fileInput && fileInput.files.length>0){
            const reader = new FileReader();
            reader.onload = function(event){
                updated.qrcode = event.target.result;
                saveTicket(updated);
            }
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            saveTicket(updated);
        }
    });

    function saveTicket(updated){
        updated.key = currentKey;
        fetch('/api/tickets', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(updated)
        }).then(()=>fetchTickets());
    }

    // Поиск
    const searchInput = document.getElementById('search');
    function filteredTickets(){
        const term = searchInput.value.toLowerCase();
        return tickets.filter(t=> t.fullname.toLowerCase().includes(term) || (t.ticketNumber && t.ticketNumber.includes(term)));
    }
    searchInput.addEventListener('input', ()=>renderTable(filteredTickets()));

    fetchTickets();
</script>

</body>
</html>
