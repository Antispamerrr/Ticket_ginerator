<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Генератор билета</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 40px; }
        h1 { text-align: center; }
        form { max-width: 500px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        label { display: block; margin-bottom: 10px; }
        input { width: 100%; padding: 8px; margin-top: 4px; border-radius: 5px; border: 1px solid #ccc; }
        button { margin-top: 15px; padding: 10px 15px; background: #007bff; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #result { margin-top: 20px; text-align: center; }
        #result a { display: block; word-break: break-all; margin-bottom: 10px; }
    </style>
</head>
<body>

<h1>Создание / Редактирование билета</h1>

<form id="ticketForm">
    <label>Имя и фамилия:<input type="text" name="fullname" required></label>
    <label>Дата рождения (дд.мм.гггг):
        <input type="text" name="birthdate" placeholder="01.01.1990" pattern="\d{2}\.\d{2}\.\d{4}" required>
    </label>
    <label>Месяц отправления (число 1-12):
        <input type="number" name="departureMonth" min="1" max="12" required>
    </label>
    <label>Месяц прибытия (число 1-12):
        <input type="number" name="arrivalMonth" min="1" max="12" required>
    </label>
    <label>Дата выдачи (дд.мм.гггг, чч:мм Uhr):
        <input type="text" name="issuedAt" placeholder="01.03.2025, 14:30 Uhr"
               pattern="\d{2}\.\d{2}\.\d{4}, \d{2}:\d{2} Uhr" required>
    </label>

    <label>QR-код (файл изображения):<input type="file" id="qrfile" accept="image/*"></label>
    <button type="submit">Сохранить билет</button>
    <button type="button" id="manageBtn">Управление билетами</button>
</form>

<div id="result"></div>

<script>
    const form = document.getElementById('ticketForm');
    const manageBtn = document.getElementById('manageBtn');
    let editKey = null;

    // фиксированные параметры
    const FIXED_YEAR = 2025;
    const FIXED_DAY = 1;
    const FIXED_DEPARTURE_TIME = "00:00";
    const FIXED_ARRIVAL_TIME = "03:00";

    // преобразование дд.мм.гггг → YYYY-MM-DD
    function parseBirthdate(input) {
        const [day, month, year] = input.split(".");
        if (!day || !month || !year) return "";
        return `${year}-${month}-${day}`;
    }

    // генерация случайного 7-значного номера билета
    function generateTicketNumber() {
        return String(Math.floor(1000000 + Math.random() * 9000000));
    }

    window.addEventListener('DOMContentLoaded', async () => {
        const params = new URLSearchParams(window.location.search);
        editKey = params.get('editKey');
        if (!editKey) return;

        try {
            const res = await fetch('/api/tickets');
            const tickets = await res.json();
            const ticket = tickets.find(t => t.key === editKey);
            if (!ticket) return alert('Билет с таким ключом не найден');

            form.fullname.value = ticket.fullname;
            form.birthdate.value = ticket.birthdate; // дд.мм.гггг

            if(ticket.validFromISO){
                const d = new Date(ticket.validFromISO);
                form.departureMonth.value = d.getMonth() + 1;
            }
            if(ticket.validUntilISO){
                const d = new Date(ticket.validUntilISO);
                form.arrivalMonth.value = d.getMonth() + 1;
            }

            form.issuedAt.value = ticket.issuedAtISO || '';
            form.ticketNumber.value = ticket.ticketNumber; // существующий номер

            if(ticket.qrcode){
                const qrPreview = document.createElement('img');
                qrPreview.src = ticket.qrcode;
                qrPreview.style.width = '100px';
                qrPreview.style.display = 'block';
                qrPreview.style.marginTop = '10px';
                form.appendChild(qrPreview);
            }
        } catch(err){
            console.error(err);
        }
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = new FormData(form);

        const departureMonth = parseInt(data.get('departureMonth'), 10);
        const arrivalMonth   = parseInt(data.get('arrivalMonth'), 10);
        const issuedAtInput  = data.get('issuedAt');

        // создаём ISO строки с фиксированным днём и годом
        const departureISO = `${FIXED_YEAR}-${String(departureMonth).padStart(2,'0')}-${String(FIXED_DAY).padStart(2,'0')}T${FIXED_DEPARTURE_TIME}`;
        const arrivalISO   = `${FIXED_YEAR}-${String(arrivalMonth).padStart(2,'0')}-${String(FIXED_DAY).padStart(2,'0')}T${FIXED_ARRIVAL_TIME}`;

        // если редактирование, сохраняем номер, иначе генерируем новый
        let ticketNumber;
        if(editKey && existingTicket) {
            ticketNumber = existingTicket.ticketNumber; // при редактировании оставляем прежний номер
        } else {
            ticketNumber = generateTicketNumber();     // при создании новый номер
        }
        if (!ticketNumber) ticketNumber = generateTicketNumber();

        const ticketData = {
            fullname: data.get('fullname'),
            birthdate: data.get('birthdate'),
            birthdateISO: parseBirthdate(data.get('birthdate')),
            validFrom: formatDateTimeForTicket(departureISO),
            validFromISO: departureISO,
            validUntil: formatDateTimeForTicket(arrivalISO),
            validUntilISO: arrivalISO,
            issuedAt: formatIssuedAt(issuedAtInput),
            issuedAtISO: issuedAtInputToISO(issuedAtInput),
            region: 'Deutschlandweit',
            priceLevel: 'deutschlandweit',
            ticketNumber: ticketNumber,
            qrcode: ''
        };

        // загрузка QR-кода и отправка
        const file = document.getElementById('qrfile').files[0];
        if(file){
            const reader = new FileReader();
            reader.onload = async (ev) => {
                ticketData.qrcode = ev.target.result;
                await submitTicket(ticketData);
            };
            reader.readAsDataURL(file);
        } else {
            await submitTicket(ticketData);
        }
    });

    async function submitTicket(ticketData){
        try {
            let res;
            if(editKey){
                res = await fetch(`/api/tickets/${editKey}`, {
                    method: 'PUT',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(ticketData)
                });
            } else {
                res = await fetch('/api/tickets', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify(ticketData)
                });
            }

            if(!res.ok) throw new Error('Ошибка при сохранении билета');
            const resp = await res.json();
            const ticketUrl = `ticket.html?key=${resp.key}`;
            document.getElementById('result').innerHTML = `<p>Ссылка на билет:</p><a href="${ticketUrl}" target="_blank">${ticketUrl}</a>`;
            form.reset();
        } catch(err){
            alert(err.message);
            console.error(err);
        }
    }

    manageBtn.addEventListener('click', () => {
        window.location.href = 'manage_tickets.html';
    });

    // форматирование дат
    function formatDateTimeForTicket(inputDate) {
        const date = new Date(inputDate);
        const pad = n => String(n).padStart(2,'0');
        return `${pad(date.getDate())}.${pad(date.getMonth()+1)}.${date.getFullYear()} - ${pad(date.getHours())}:${pad(date.getMinutes())}`;
    }

    function issuedAtInputToISO(inputDate) {
        const match = inputDate.match(/(\d{2})\.(\d{2})\.(\d{4}), (\d{2}):(\d{2})/);
        if (!match) return null;
        const [_, day, month, year, hour, minute] = match;
        return `${year}-${month}-${day}T${hour}:${minute}:00`;
    }

    function formatIssuedAt(inputDate) {
        const match = inputDate.match(/(\d{2})\.(\d{2})\.(\d{4}), (\d{2}):(\d{2})/);
        if(!match) return inputDate;

        const [_, day, month, year, hour, minute] = match;
        const date = new Date(`${year}-${month}-${day}T${hour}:${minute}`);
        const pad = n => String(n).padStart(2,'0');
        return `${pad(date.getDate())}.${pad(date.getMonth()+1)}.${date.getFullYear()}, ${pad(date.getHours())}:${pad(date.getMinutes())} Uhr`;
    }
</script>
</body>
</html>
